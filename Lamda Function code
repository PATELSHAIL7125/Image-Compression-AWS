import {
  S3Client,
  PutObjectCommand,
  GetObjectCommand
} from "@aws-sdk/client-s3";
import { getSignedUrl } from "@aws-sdk/s3-request-presigner";
import sharp from "sharp";
import { randomUUID } from "crypto";

const s3 = new S3Client({ region: process.env.AWS_REGION });
const BUCKET_NAME = "image-resize-demo-shail";

export const handler = async (event) => {
  try {
    const body = JSON.parse(event.body);
    const imageBuffer = Buffer.from(body.image, "base64");

    const originalFileName = `original-${randomUUID()}.jpg`;
    const resizedFileName = `resized-${randomUUID()}.jpg`;

    // 1️⃣ Upload ORIGINAL image to uploads/
    await s3.send(
      new PutObjectCommand({
        Bucket: BUCKET_NAME,
        Key: `uploads/${originalFileName}`,
        Body: imageBuffer,
        ContentType: "image/jpeg",
      })
    );

    // 2️⃣ Resize image
    const resizedImage = await sharp(imageBuffer)
      .resize(300, 300)
      .jpeg()
      .toBuffer();

    // 3️⃣ Upload RESIZED image to resized/
    await s3.send(
      new PutObjectCommand({
        Bucket: BUCKET_NAME,
        Key: `resized/${resizedFileName}`,
        Body: resizedImage,
        ContentType: "image/jpeg",
      })
    );

    // 4️⃣ Generate presigned URL for resized image
    const getCommand = new GetObjectCommand({
      Bucket: BUCKET_NAME,
      Key: `resized/${resizedFileName}`,
    });

    const signedUrl = await getSignedUrl(s3, getCommand, {
      expiresIn: 3600, // 1 hour
    });

    return {
      statusCode: 200,
      headers: {
        "Access-Control-Allow-Origin": "*",
      },
      body: JSON.stringify({
        message: "Image uploaded and resized successfully",
        downloadUrl: signedUrl,
      }),
    };
  } catch (error) {
    console.error("ERROR:", error);
    return {
      statusCode: 500,
      headers: {
        "Access-Control-Allow-Origin": "*",
      },
      body: JSON.stringify({ error: error.message }),
    };
  }
};
